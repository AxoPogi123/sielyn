<!DOCTYPE html>
<html>
<head>
  <title>Student Xiao Sun</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <style>
    html, body { height: 100%; }
    body {
      background-color: #000000;
      margin: 0;
      font-family: Helvetica, Arial, sans-serif;
      overflow: hidden;
    }

    a { color: #ffffff; }

    #menu {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      z-index: 10;
    }

    button {
      color: rgba(127, 255, 255, 0.85);
      background: transparent;
      outline: 1px solid rgba(127, 255, 255, 0.75);
      border: 0px;
      padding: 5px 12px;
      cursor: pointer;
      margin: 0 6px;
      border-radius: 10px;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    button:hover { background-color: rgba(0, 255, 255, 0.4); }
    button:active { color: #000000; background-color: rgba(0, 255, 255, 0.8); }

    /* CSS3D tiles */
    .element {
      width: 100px;
      height: 100px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
      border: 1px solid rgba(127, 255, 255, 0.25);
      text-align: center;
      cursor: default;
      overflow: hidden;
      background: rgba(0,127,127,0.35);
      border-radius: 6px;
    }
    .element:hover { box-shadow: 0 0 12px rgba(0, 255, 255, 0.75); border: 1px solid rgba(127, 255, 255, 0.75); }
    .element img { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* Heart button as outlined text */
    .heart-button {
      background: transparent;
      border: none;
      outline: 1px solid rgba(127, 255, 255, 0.75);
      color: transparent;             /* fill transparent */
      -webkit-text-stroke: 1px rgba(255, 80, 120, 0.95); /* outlined text */
      text-stroke: 1px rgba(255, 80, 120, 0.95);
    }
    .heart-button:hover { background: rgba(255, 80, 120, 0.2); }

    #love-text {
      position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 42px;
      color: #ff3b7d;
      -webkit-text-stroke: 1px #ffffff;
      text-shadow: 0 0 18px rgba(255,255,255,0.4);
      font-weight: 800;
      display: none;
      z-index: 9;
      user-select: none;
    }

    /* Layer the two renderers on top of each other */
    #container { position: absolute; inset: 0; }
    canvas.webgl { position: absolute; inset: 0; z-index: 0; }
    div.css3d { position: absolute; inset: 0; z-index: 1; }
  </style>
  <link rel="stylesheet" href="css/animate.min.css" />
</head>
<body>
  <script src="js/jquery.min.js"></script>
  <script src="js/three.js"></script>
  <script src="js/tween.min.js"></script>
  <script src="js/TrackballControls.js"></script>
  <script src="js/CSS3DRenderer.js"></script>

  <div id="container"></div>
  <audio autoplay loop>
    <source src="http://www.ytmp3.cn/down/72794.mp3" />
  </audio>
  <div id="menu">
    <button id="table">Table</button>
    <button id="sphere">Sphere</button>
    <button id="helix">Helix</button>
    <button id="grid">Grid</button>
    <button class="heart-button" id="heart">HEART</button>
  </div>

  <div id="love-text">I love you Jess</div>

  <script>
    // --- Data --------------------------------------------------------------
    var personArray = [];
    for (var i = 0; i < 199; i++) { personArray.push({ image: "img/a.png" }); }

    var table = [];
    for (var i = 0; i < personArray.length; i++) {
      table[i] = Object.assign({}, personArray[i]);
      table[i].p_x = (i % 20) + 1;                // column
      table[i].p_y = Math.floor(i / 20) + 1;      // row
    }

    // --- Three.js: dual scenes (WebGL for 3D heart, CSS3D for tiles) -----
    var camera, controls;
    var webglRenderer, cssRenderer;
    var webglScene, cssScene;

    var objects = [];
    var targets = { table: [], sphere: [], helix: [], grid: [], heart: [] };

    var heartMesh; // 3D heart model

    init();
    animate();

    function init() {
      camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
      camera.position.z = 3000;

      // Scenes
      webglScene = new THREE.Scene();
      cssScene = new THREE.Scene();

      // Lights for WebGL
      var ambient = new THREE.AmbientLight(0xffffff, 0.6);
      webglScene.add(ambient);
      var dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(1, 1, 1);
      webglScene.add(dir);

      // Build CSS3D tiles
      for (var i = 0; i < table.length; i++) {
        var el = document.createElement('div');
        el.className = 'element';

        var img = document.createElement('img');
        img.src = table[i].image;
        img.onerror = function(){ this.style.display = 'none'; };
        el.appendChild(img);

        var cssObj = new THREE.CSS3DObject(el);
        cssObj.position.x = Math.random() * 4000 - 2000;
        cssObj.position.y = Math.random() * 4000 - 2000;
        cssObj.position.z = Math.random() * 4000 - 2000;
        cssScene.add(cssObj);
        objects.push(cssObj);

        // Table target (grid-like lattice)
        var t = new THREE.Object3D();
        t.position.x = (table[i].p_x * 140) - 1330;
        t.position.y = - (table[i].p_y * 180) + 990;
        targets.table.push(t);
      }

      // Sphere targets
      var vector = new THREE.Vector3();
      var spherical = new THREE.Spherical();
      for (var i = 0, l = objects.length; i < l; i++) {
        var phi = Math.acos(-1 + (2 * i) / l);
        var theta = Math.sqrt(l * Math.PI) * phi;
        var o = new THREE.Object3D();
        spherical.set(800, phi, theta);
        o.position.setFromSpherical(spherical);
        vector.copy(o.position).multiplyScalar(2);
        o.lookAt(vector);
        targets.sphere.push(o);
      }

      // Helix targets
      var cylindrical = new THREE.Cylindrical();
      for (var i = 0, l = objects.length; i < l; i++) {
        var th = i * 0.175 + Math.PI;
        var y = - (i * 5) + 450;
        var o = new THREE.Object3D();
        cylindrical.set(900, th, y);
        o.position.setFromCylindrical(cylindrical);
        o.lookAt(new THREE.Vector3(o.position.x * 2, o.position.y, o.position.z * 2));
        targets.helix.push(o);
      }

      // Grid targets
      for (var i = 0; i < objects.length; i++) {
        var o = new THREE.Object3D();
        o.position.x = ((i % 5) * 400) - 800;
        o.position.y = (-(Math.floor(i / 5) % 5) * 300) + 500;
        o.position.z = (Math.floor(i / 25)) * 200 - 800;
        targets.grid.push(o);
      }

      // Heart layout targets (2D heart curve, spread across all tiles)
      for (var i = 0, l = objects.length; i < l; i++) {
        var t = i / l * Math.PI * 2; // 0..2Ï€
        var x = 16 * Math.pow(Math.sin(t), 3);
        var y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
        var o = new THREE.Object3D();
        o.position.set(x * 50, y * 50, 0);
        targets.heart.push(o);
      }

      // --- WebGL: 3D Heart mesh -----------------------------------------
      heartMesh = buildHeartMesh();
      heartMesh.position.set(0, 0, 0);
      heartMesh.scale.set(30, 30, 30);
      heartMesh.visible = false; // only show in HEART mode
      webglScene.add(heartMesh);

      // Renderers
      webglRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      webglRenderer.setSize(window.innerWidth, window.innerHeight);
      webglRenderer.domElement.className = 'webgl';
      document.getElementById('container').appendChild(webglRenderer.domElement);

      cssRenderer = new THREE.CSS3DRenderer();
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
      cssRenderer.domElement.className = 'css3d';
      document.getElementById('container').appendChild(cssRenderer.domElement);

      // Controls (attach to top layer for pointer events)
      controls = new THREE.TrackballControls(camera, cssRenderer.domElement);
      controls.rotateSpeed = 0.6;
      controls.minDistance = 500;
      controls.maxDistance = 6000;
      controls.addEventListener('change', render);

      // Buttons
      document.getElementById('table').addEventListener('click', function(){
        heartMesh.visible = false; hideLoveText();
        transform(targets.table, 1200);
      });
      document.getElementById('sphere').addEventListener('click', function(){
        heartMesh.visible = false; hideLoveText();
        transform(targets.sphere, 1600);
      });
      document.getElementById('helix').addEventListener('click', function(){
        heartMesh.visible = false; hideLoveText();
        transform(targets.helix, 1600);
      });
      document.getElementById('grid').addEventListener('click', function(){
        heartMesh.visible = false; hideLoveText();
        transform(targets.grid, 1600);
      });
      document.getElementById('heart').addEventListener('click', function(){
        transform(targets.heart, 1600);
        heartMesh.visible = true;                      // show 3D heart
        document.getElementById('love-text').style.display = 'block';
      });

      // Initial arrangement
      transform(targets.table, 1800);
      window.addEventListener('resize', onWindowResize, false);
    }

    function buildHeartMesh(){
      // Create a 2D heart Shape using bezier curves and extrude it into 3D
      var x = 0, y = 0;
      var heartShape = new THREE.Shape();
      heartShape.moveTo( x + 0, y + 0 );
      heartShape.bezierCurveTo( x + 0, y + 0, x - 6, y - 6, x - 6, y - 12 );
      heartShape.bezierCurveTo( x - 6, y - 20, x + 2, y - 24, x + 0, y - 30 );
      heartShape.bezierCurveTo( x - 2, y - 36, x - 12, y - 38, x - 18, y - 30 );
      heartShape.bezierCurveTo( x - 30, y - 14, x + 0, y + 6, x + 0, y + 6 );
      heartShape.bezierCurveTo( x + 0, y + 6, x + 30, y - 14, x + 18, y - 30 );
      heartShape.bezierCurveTo( x + 12, y - 38, x + 2, y - 36, x + 0, y - 30 );
      heartShape.bezierCurveTo( x - 2, y - 24, x + 6, y - 20, x + 6, y - 12 );
      heartShape.bezierCurveTo( x + 6, y - 6, x + 0, y + 0, x + 0, y + 0 );

      var extrudeSettings = { depth: 2.8, bevelEnabled: true, bevelSegments: 3, steps: 32, bevelSize: 0.6, bevelThickness: 0.6 };
      var geo = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
      geo.center();

      var mat = new THREE.MeshPhongMaterial({ color: 0xff3b7d, shininess: 120, specular: 0xffffff });
      var mesh = new THREE.Mesh(geo, mat);
      return mesh;
    }

    function transform(targetsArray, duration) {
      TWEEN.removeAll();
      for (var i = 0; i < objects.length; i++) {
        var obj = objects[i];
        var target = targetsArray[i];
        new TWEEN.Tween(obj.position)
          .to({ x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration)
          .easing(TWEEN.Easing.Exponential.InOut)
          .start();
        new TWEEN.Tween(obj.rotation)
          .to({ x: target.rotation.x || 0, y: target.rotation.y || 0, z: target.rotation.z || 0 }, Math.random() * duration + duration)
          .easing(TWEEN.Easing.Exponential.InOut)
          .start();
      }
      new TWEEN.Tween(this).to({}, duration * 2).onUpdate(render).start();
    }

    function hideLoveText(){ document.getElementById('love-text').style.display = 'none'; }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      webglRenderer.setSize(window.innerWidth, window.innerHeight);
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
      render();
    }

    function animate() {
      requestAnimationFrame(animate);
      if (heartMesh && heartMesh.visible) { heartMesh.rotation.y += 0.01; }
      TWEEN.update();
      controls.update();
      render();
    }

    function render() {
      webglRenderer.render(webglScene, camera);
      cssRenderer.render(cssScene, camera);
    }
  </script>
</body>
</html>
